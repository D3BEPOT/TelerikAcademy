(function(){addEventListener("message",function(a){var b,c,d,e,f,g,h;for(b={field:a.data.field,moves:a.data.moves,result:0,log:[]},d={queue:[],totalChanged:0,addState:function(a,b,c){return this.queue.push([{point:a,delta:b,result:c}])},addToState:function(a,b,c){return this.queue[this.queue.length-1].push({point:a,delta:b,result:c})}},c=function(){function c(a,b){this.x=a,this.y=b}var a;return a=[new c(0,-1),new c(-1,0),new c(1,0),new c(0,1)],c.prototype.getValue=function(){return b.field[this.x][this.y]},c.prototype._changeValue=function(a){return b.field[this.x][this.y]+=a},c.prototype.changeValue=function(a,c){return c||b.log.push("  Move: "+d.queue.length),b.log.push("    Changing "+this.x+":"+this.y+" = "+this.getValue()+" + "+a+"."),d.totalChanged++,this.getValue()+a>-1&&(this._changeValue(a),b.result-=a),d[c?"addToState":"addState"](this,a,b.result),this},c.prototype.checkNeighbours=function(){var d,e,f,g,h,i,j,k;for(g=0,h=a.length;h>g;g++)d=a[g],f=new c(this.x+d.x,this.y+d.y),(i=f.x)>-1&&b.field.length>i&&(j=f.y)>-1&&b.field.length>j&&(k=this.getValue())>0&&k===f.getValue()&&(e=!0,f.changeValue(-f.getValue(),!0));return e?this.changeValue(-this.getValue(),!0):void 0},c}(),postMessage("  Received field "+b.field.length+"*"+b.field.length+"."),postMessage("  Received "+b.moves.length+" moves."),h=b.moves,f=0,g=h.length;g>f;f++)e=h[f],new c(e[1],e[2]).changeValue({put:1,take:-1}[e[0]]).checkNeighbours();return b.log.push("  Total towers changed: "+d.totalChanged),b.log.push("  Result: "+b.result),postMessage(b.log.join("\n")),postMessage({moves:d.queue,totalChanged:d.totalChanged,result:b.result})},!1)}).call(this);
