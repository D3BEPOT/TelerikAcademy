<!doctype html>
<html data-ng-app="game" class="nojs">
<head>
    <meta charset="utf-8">

    <title>Игра на Тролове</title>
    <meta name="description" content="Задача 1 от конкурса на Telerik и PC Magazine Bulgaria, 2012/2013" />

    <script>
        !function(e) { e.className = 'js', 'ontouchstart' in e && (e.className += ' touch') }(document.documentElement)
    </script>

    <!-- build:css styles/all.css -->
    <link rel="stylesheet" href="styles/vendor/bootstrap.css">
    <link rel="stylesheet" href="styles/animate.css">
    <link rel="stylesheet" href="styles/main.css">
    <!-- endbuild -->
</head>

<body>
    <!-- HEADER -->
    <header class="navbar navbar-inverse navbar-static-top">
        <nav class="navbar-inner">
            <div class="container">
                <a class="brand" href="./">Тролски кули</a>

                <ul class="nav">
                    <li class="active"><a href="./">Начало</a></li>
                    <li><a href="tests/1Mtowers.txt" target="_blank">Кули</a></li>
                    <li><a href="tests/1Kmoves.txt" target="_blank">Ходове</a></li>
                    <li><a href="tests/">Тестове</a></li>
                    <li><a href="http://git.io/LdWjqw">GitHub</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- CONTENT -->
    <article class="container">
        <header class="page-header">
            <h1>Игра на тролове <small>Задача от конкурса на Телерик</small></h1>
        </header>

        <noscript>
            <p class="text-error pagination-centered">Това приложение изисква JavaScript!</p>
        </noscript>

        <!-- ******************************************************************************************************* -->
        <!-- *********************************************** INPUT ************************************************* -->
        <!-- ******************************************************************************************************* -->

        <form name="input" class="input well form-horizontal" data-ng-controller="inputController"
          data-ng-hide="state == 'loaded'" data-ng-submit="callWorker()">
            <fieldset>
                <legend>Въведи кули и ходове</legend>

                <!-- N -->
                <dl class="control-group" data-ng-class="{ error: !(input.n.$valid || input.n.$pristine) }">
                    <dt><label for="label-n" class="control-label">N:</label></dt>

                    <dd class="controls">
                        <input disabled required autofocus type="number" class="input-mini" data-ng-model="n" name="n"
                          id="label-n" placeholder="1/1000" min="1" max="1000" data-ng-disabled="state == 'calculating'"
                          data-ng-pattern="/^\d+$/" />

                        <ul class="ng-cloak inline">
                            <li class="help-inline" data-ng-show="n == 1000 && input.$valid">
                                <a href="http://youtu.be/mUE9R6h1CRg">Successful troll is successful!</a>
                            </li>
                            <li class="help-inline" data-ng-show="input.n.$error.required">Въведете число.</li>
                            <li class="help-inline" data-ng-show="input.n.$error.pattern">Цяло число.</li>
                            <li class="help-inline" data-ng-show="input.n.$error.min">Минимум 1.</li>
                            <li class="help-inline" data-ng-show="input.n.$error.max">Максимум 1000.</li>
                        </ul>
                    </dd>
                </dl>

                <!-- FIELD -->
                <dl class="control-group" data-ng-class="{ error: !input.field.$valid }">
                    <dt>
                        <label for="label-field" class="control-label">
                            <i class="ng-cloak" data-ng-class="input.field.parsing && 'icon-refresh' || 'icon-ok'"
                              data-ng-show="!input.field.$pristine && input.field.$valid && input.n.$valid"></i>

                            Вход:
                        </label>
                    </dt>

                    <dd class="controls">
                        <textarea disabled class="input-block-level" data-ng-model="field" name="field" id="label-field"
                          rows="10" data-ng-disabled="state == 'calculating' || !input.n.$valid"
                          data-matrix data-matrix-rows="{{ n }}" data-matrix-cols="{{ n }}" data-matrix-min="0"
                          data-matrix-max="1000"></textarea>

                        <ul class="ng-cloak inline">
                            <li class="help-block" data-ng-show="input.field.$valid">
                                <span class="muted">Това са кулите.</span>
                            </li>
                            <li class="help-block" data-ng-show="input.field.$error.required">
                                Въведете поле.
                            </li>
                            <li class="help-block" data-ng-show="input.field.$error.matrix">
                                Невалиден формат на полето.
                            </li>
                            <li class="help-block" data-ng-show="input.field.$error.matrixRows">
                                Броят редове беше {{ input.field.errorLength }}, a не {{ n }}.
                            </li>
                            <li class="help-block" data-ng-show="input.field.$error.matrixCols">
                                Броят колони на ред {{ input.field.errorRow + 1 }}
                                беше {{ input.field.errorLength }}, а не {{ n }}.
                            </li>
                            <li class="help-block" data-ng-show="input.field.$error.matrixPattern">
                                Клетката на ред {{ input.field.errorRow + 1 }},
                                колона {{ input.field.errorCol + 1 }} не е цяло число,
                                a e "{{ input.field.errorCell }}".
                            </li>
                            <li class="help-block" data-ng-show="input.field.$error.matrixMin">
                                Клетката на ред {{ input.field.errorRow + 1 }},
                                колона {{ input.field.errorCol + 1 }} e "{{ input.field.errorCell }}" &lt; 0.
                            </li>
                            <li class="help-block" data-ng-show="input.field.$error.matrixMax">
                                Клетката на ред {{ input.field.errorRow + 1 }},
                                колона {{ input.field.errorCol + 1 }} e "{{ input.field.errorCell }}" &gt; 1000.
                            </li>
                        </ul>
                    </dd>
                </dl>

                <!-- MOVES -->
                <dl class="control-group" data-ng-class="{ error: !input.moves.$valid }">
                    <dt>
                        <label for="label-moves" class="control-label">
                            <i class="ng-cloak" data-ng-class="input.moves.parsing && 'icon-refresh' || 'icon-ok'"
                              data-ng-show="!input.moves.$pristine && input.moves.$valid && input.n.$valid"></i>

                            Изход:
                        </label>
                    </dt>

                    <dd class="controls">
                        <textarea disabled class="input-block-level" data-ng-model="moves" name="moves" id="label-moves"
                          rows="7" data-ng-disabled="state == 'calculating' || !input.n.$valid"
                          data-matrix data-matrix-rows="1000" data-matrix-cols="3" data-matrix-min="0"
                          data-matrix-max="{{ n - 1 }}" data-matrix-command></textarea>

                        <ul class="ng-cloak inline">
                            <li class="help-block" data-ng-show="input.moves.$valid">
                                <span class="muted">Това са ходовете.</span>
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.required">
                                Въведете ходове.
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.matrix">
                                Невалиден формат на ходовете.
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.matrixRows">
                                Броят ходове беше {{ input.moves.errorLength }} &gt; 1000.
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.matrixCols">
                                Броят колони на ред {{ input.moves.errorRow + 1 }}
                                беше {{ input.moves.errorLength }}, а не 3.
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.matrixCommand">
                                Ход номер {{ input.moves.errorRow + 1 }} не е "put" или "take".
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.matrixPattern">
                                Кула номер {{ input.moves.errorCol }} на ход
                                {{ input.moves.errorRow + 1 }} не е цяло число, а е "{{ input.moves.errorCell }}".
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.matrixMin">
                                Кула номер {{ input.moves.errorCol }} на ход
                                {{ input.moves.errorRow + 1 }} e "{{ input.moves.errorCell }}" &lt; 0.
                            </li>
                            <li class="help-block" data-ng-show="input.moves.$error.matrixMax">
                                Кула номер {{ input.moves.errorCol }} на ход
                                {{ input.moves.errorRow + 1 }} e "{{ input.moves.errorCell }}" &gt; {{ n - 1 }}.
                            </li>
                        </ul>
                    </dd>
                </dl>

                <!-- SAMPLE INPUT -->
                <input type="hidden" data-ng-init="
                  n = 30;
                  field = [
                    [ 1, 2, 3, 4,22, 2, 3,18,20,26, 9,28, 5, 6, 0,10,11, 2,25,18,28,10,27,14,13,12,13,29, 9,10],
                    [ 5, 6, 7, 8,29,24,29,25, 1,22,26, 5,22, 5,22, 3, 0,17,16,18, 6, 7,18,11, 8,21, 3,22, 8,9],
                    [ 9, 1, 8, 7,17,24,22, 3,21,18, 7,26,15,25,21,16,28, 7,21,26, 1,23,17,11, 0, 7, 3,10,17,20],
                    [ 1, 2, 3, 4,16,14,20,13,17, 6, 0,23, 0,22,22,25,26,11, 4, 5,10, 2, 6,10,10, 2,26, 7,27, 2],
                    [10, 4,16,15, 5,29,20,26,14,11,29, 8, 4,27,29,16, 4,29,21,14,12, 7, 6,20,25, 5,18, 0,26, 1],
                    [24,22,16,14, 7, 2, 4,17,11,27,13,28,11,24,26,25, 3,28,14,14,14, 3,13,11,13,28,13,22, 1, 1],
                    [10,17, 3,10, 1,15, 7,20,27,13,17,29, 1,13,16,13, 5,28,24, 2,20, 6, 1,23,11,18,19, 5, 6,14],
                    [15,28,25,24,12,27,13,15,15,19,23,18, 2, 0,19,25,18,29,29,12,27, 4,20,27,27, 1, 2,19, 5, 0],
                    [12,17,21,13, 8,29, 1,13,17,24,27,28,16, 9,11,23,11,27,16,14, 5,18, 5,29, 6,19, 9, 8,25,15],
                    [20,25,19,19,23,27,28,10,20,26,15,15, 9,14, 8,23, 7,25,15,16,22, 0,14, 2, 1, 8,28, 2,27, 9],
                    [26,20,10,21,18,24, 3, 9, 9,28,27, 3,14, 6, 1,14, 7, 2,26, 1,15, 6,22,25,24,15, 4, 0, 3,15],
                    [ 3,23,25, 3,20, 4, 5,25,15, 8,25,17, 1,16, 0,26, 5, 2,22,16,12,12,12,25,20,11,28, 9, 0,23],
                    [23, 3, 1,22,22,21,21, 1,12,27,17,18,19,18,16, 2,27, 4,27, 9,18,19,20,23,12, 2,17,25, 6, 9],
                    [24, 6,17,11,16, 5,26,14,27,26,27, 4,13, 1,22,21, 0,25,21,14,25,28, 9,27, 5,10, 3, 1, 6,21],
                    [22, 9,14,27,22,24,25,21,18,27,16, 2,26,29, 6, 9,26, 6,26, 8,10, 3,20, 2,28, 6,28,26,18, 7],
                    [28, 5, 8,26, 9,27,17,25, 0, 3, 3, 7,14,11, 5,21,20,29,24, 6,17, 9,19,17,27, 1,20,25,26,28],
                    [10,21, 4,27,10,18,21, 0,19,20,29, 5, 2, 7, 7,18, 7,12,29, 3,14,22,26, 2,25,10, 6,20,22,20],
                    [22, 7,21, 3, 5, 7,20,29,27,19,28, 6,13,21,27,22,12,10,16, 2,26,24,14,15,11,26, 6,15,12,12],
                    [16,23,16,28,12,20, 9, 6,20,23,15,10, 8,24, 0,23,11, 0,10,26,13, 7,17,24,17,16,13, 1, 2, 6],
                    [ 2, 6,29,10,25,26,23,11,27,29, 8,28,10, 1,29,14,14,13,26,22,28,23,14,29,16,22,28,16, 0,25],
                    [ 8, 1,12,28,11, 0, 7,28,17,28,21,16,19,20,28, 0,23,17,20,10, 2,17, 9,13,22,23, 2, 9,12,27],
                    [ 9, 0,21, 1,15, 3,27, 0,13,25,19,27,21, 0,26, 5, 2,24,17,18,10,23,23,18,10,12, 9,25,13, 5],
                    [26,12,26, 3, 8,18, 8,29, 1,22,18,21,24,14,15,12,20,29, 3, 8,11,23,19,19,23, 7,29,19,24,18],
                    [ 8,28, 0,26,22,20,16,17,16, 8,26, 4,17,11,29,14,17,10,10,20,10,17,19, 0,24,27,28, 3,12, 1],
                    [ 7, 6, 9, 1,10,11,19,16,11,20,13,22,27, 1,29,23, 4,26,26,17,15, 1,10,14,15, 3,20,14,26, 1],
                    [13, 7,10, 4,22,16, 9, 4,11,10, 6, 6, 2, 7,18,26,12, 7, 2,29,29,11,14, 0,12,26,27,11,10,18],
                    [13,21, 1, 2,19, 3, 7,26,22, 7,13, 2, 0, 5, 2,10, 3,22,18, 7, 2, 6,15, 4,14, 1, 5,23,22,22],
                    [14,26,26,20, 4,15,27,25,23,18,22, 7, 7, 2,26, 4,13,28,24,10, 0, 6, 6,13,28,27,11,15,11,22],
                    [27, 2,22, 3,20,11, 9, 3,17, 5, 0, 6,16,24, 8,19, 4,13,25,25, 4,20,10, 0,26,29,12,23, 1,12],
                    [20, 2, 5, 3, 2,21,23, 0,20, 5,28,23, 7,16, 6, 1, 5,11,17, 3, 4, 4,11, 6,15, 5, 7,29,12,18]
                  ];
                  moves = [
                    ['put' ,  2,  3],
                    ['take',  3,  1],
                    ['take', 23,  7],
                    ['put' ,  2, 14],
                    ['take',  0, 14],
                    ['take',  0, 29],
                    ['put' , 13,  9]
                  ];" />

                <!-- SUBMIT -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" data-ng-disabled="!input.$valid"
                      data-ng-show="state == 'waiting'">Въведи</button>

                    <p class="btn disabled ng-cloak" data-ng-show="state == 'calculating'">
                        <i class="icon-time"></i> Изчисляваме играта...
                    </p>
                </div>
            </fieldset>
        </form>

        <!-- ******************************************************************************************************* -->
        <!-- *********************************************** GAME ************************************************** -->
        <!-- ******************************************************************************************************* -->

        <div class="ng-cloak game" data-ng-controller="gameController" data-ng-show="visible" tabindex="0"
          data-ui-keydown="{
             'left': 'goBackwards    ($event)',
            'right': 'goForward      ($event)',
               'up': 'fps.increase   ($event)',
             'down': 'fps.decrease   ($event)',
            'space': 'playPause      ($event)',
                 75: 'towers.goUp()',
                 74: 'towers.goDown()',
                 76: 'towers.goRight()',
                 72: 'towers.goLeft()'
          }">

            <!-- KEYBOARD SHORTCUTS -->
            <div class="alert alert-info">
                <strong>Клавиши:</strong>

                <ul class="inline">
                    <li><code><i class="icon-arrow-left"  title="Стрелка наляво"></i></code>  Назад</li>
                    <li><code><i class="icon-arrow-right" title="Стрелка надясно"></i></code> Напред</li>
                    <li><code><i class="icon-arrow-up"    title="Стрелка нагоре"></i></code>  Забързай</li>
                    <li><code><i class="icon-arrow-down"  title="Стрелка надолу"></i></code>  Забави</li>
                    <li><code>SPACE</code> {{ !autoplay && 'Старт' || 'Пауза' }}</li>
                    <li data-ng-show="towers.hasScrollbars()">
                        <strong>VIM:</strong> <code>J/K</code> Надолу / нагоре
                    </li>
                    <li data-ng-show="towers.hasScrollbars()">
                        <code>H/L</code> Наляво / надясно
                    </li>
                </ul>
            </div>

            <div class="row">
                <!-- TOWERS -->
                <section class="towers pull-right span8">
                    <!-- STATS -->
                    <div class="row">
                        <h2 class="pull-left span">Кули</h2>

                        <div class="pull-right muted">
                            <div>
                                <ul class="inline">
                                    <li title="Краен резултат: {{ result }}">
                                        Резултат:
                                        <span class="badge">{{ currentResult }}</span>
                                    </li>
                                    <li>Размер:
                                        <span class="badge">{{ field.length }}</span>
                                    </li>
                                    <li data-ng-show="towers.hasScrollbars()">
                                        Колони:
                                        <span class="badge" data-ng-class="towers.scrollingCol && 'badge-inverse'">
                                            {{ towers._col + 1 }}-{{ towers._col + towers.count }}
                                        </span>
                                    </li>
                                    <li data-ng-show="towers.hasScrollbars()">
                                        Редове:
                                        <span class="badge" data-ng-class="towers.scrollingRow && 'badge-inverse'">
                                            {{ towers._row + 1 }}-{{ towers._row + towers.count }}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDERS -->
                    <form data-ng-show="towers.hasScrollbars()">
                        <label for="label-row" class="hide-text">Мести редове</label>
                        <input type="range" id="label-row" min="0" max="{{ field.length - towers.count }}"
                          data-ng-model="towers.row" data-ng-disabled="moving" class="vertical" />

                        <label for="label-col" class="hide-text">Мести колони</label>
                        <input type="range" id="label-col" min="0" max="{{ field.length - towers.count }}"
                          data-ng-model="towers.col" data-ng-disabled="moving" />
                    </form>

                    <!-- TOWERS -->
                    <table class="table table-bordered"
                      data-ng-class="!towers.hasScrollbars() && 'not-scrolled' || towers.scrollingMove && 'blurred'">
                        <tr data-ng-repeat="row in towers.field">
                            <td data-ng-repeat="cell in row" data-ng-class="cell.value > 999 && 'small'">
                                <span data-ng-class="cell.type">{{ !(cell.value > 0) && '0' || cell.value }}</span>
                            </td>
                        </tr>
                    </table>
                </section>

                <!-- CONTROLS -->
                <aside class="controls pull-left span4">
                    <h2>Инструменти</h2>

                    <form class="form-horizontal">
                        <!-- START/STOP -->
                        <div class="control-group">
                            <div>
                                <button class="btn btn-success btn-block btn-large" data-ng-disabled="!canGoForward()"
                                  data-ng-hide="autoplay || !getRemaining()" data-ng-click="playPause()" >
                                    Старт <i class="icon-play icon-white"></i>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-danger btn-block btn-large" data-ng-show="autoplay"
                                  data-ng-click="playPause()">
                                    Пауза <i class="icon-pause icon-white"></i>
                                </button>
                            </div>
                            <div>
                                <a href="./" class="btn btn-inverse btn-block btn-large" data-ng-hide="getRemaining()">
                                    Нова игра <i class="icon-repeat icon-white"></i>
                                </a>
                            </div>
                        </div>

                        <!-- FORWARD/BACKWARDS -->
                        <div class="control-group row">
                            <div class="span2">
                                <button class="btn btn-info btn-block" data-ng-click="goBackwards()"
                                  data-ng-disabled="!canGoBackwards()">
                                    <i class="icon-chevron-left icon-white"></i> Предишен ход
                                </button>
                            </div>
                            <div class="span2">
                                <button class="btn btn-primary btn-block" data-ng-click="goForward()"
                                  data-ng-disabled="!canGoForward()">
                                    Следващ ход <i class="icon-chevron-right icon-white"></i>
                                </button>
                            </div>
                        </div>

                        <!-- FPS RANGE -->
                        <h4>
                            Скорост на анимацията
                            <small>
                                {{ fps.current }} <abbr title="Frames per Second" class="initialism">FPS</abbr>
                            </small>
                        </h4>
                        <input type="range" class="span4" min="1" max="7" step="0.25" data-ng-model="fps.current" />
                        <!-- We could use {{fps.min}}, {{fps.max}} and {{fps.step}}, but it will be invalid HTML. -->
                    </form>

                    <!-- PROGRESS -->
                    <h4>Прогрес на играта <small>{{ currentAnimation }}/{{ totalAnimations }}</small></h4>
                    <div class="progress progress-striped progress-warning" data-ng-class="{ 'active': moving }">
                        <div class="bar" style="width: {{ 100 * currentAnimation / totalAnimations }}%"></div>
                    </div>

                    <!-- MOVES LOG -->
                    <h4>Ходове <small>{{ currentState }}/{{ getTotal() }}</small></h4>
                    <div class="well">
                        <dl data-ng-repeat="state in [currentState - 1, currentState, currentState + 1]"
                          data-ng-show="!(state < 0) && state < getTotal()">
                            <dt data-ng-class="{ muted: state != currentState }">
                                Ход {{ state + 1 }}
                                <i class="icon-thumbs-up" data-ng-show="queue[state].length > 4"></i>
                                <i class="icon-exclamation-sign" data-ng-show="queue[state][0].move.delta == 0"></i>
                            </dt>

                            <dd data-ng-repeat="move in queue[state]">
                                <code class="label" data-ng-class="state == currentState &&
                                  ({ true: 'label-warning', false: 'label-inverse' }[$index == currentSubState])">
                                    На кула {{ move.point.x + 1 }}:{{ move.point.y + 1 }}
                                    {{ move.delta > 0 && 'прибавяме' || 'махаме' }}
                                    {{ move.delta > 0 && move.delta || -move.delta }}
                                    {{ (move.delta == -1 || move.delta == 1) && 'кубче' || 'кубчета'}}.
                                </code>
                            </dd>
                        </dl>
                    </div>
                </aside>
            </div>
        </div>

        <!-- CONSOLE.LOG -->
        <p class="alert"><strong>Внимание:</strong> Ще намерите допълнителна информация в конзолата.</p>
    </article>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <ul class="inline pull-left">
                <li><a href="http://www.w3.org/html/logo/">HTML</a></li>
                <li><a href="http://compass-style.org/">SASS + Compass</a></li>
                <li><a href="http://coffeescript.org/">CoffeeScript</a></li>
                <li><a href="http://angularjs.org/">Google AngularJS</a></li>
                <li><a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a></li>
                <li><a href="http://visionmedia.github.com/mocha/">Мocha</a></li>
                <li><a href="https://github.com/">GitHub</a></li>
                <li><a href="http://yeoman.io/">Yeoman</a></li>
            </ul>
            <p class="pull-right muted"><small>&copy; jasssonpet 2012</small></p>
        </div>
    </footer>

    <!--
        TODO:
        * Use router and split into input and game files.
        * Use custom scollbars.
    -->

    <!-- build:js scripts/all.js -->
    <script src="scripts/vendor/angular.js"></script>
    <script src="scripts/vendor/angular.ui.keydown.js"></script>
    <script src="scripts/root.js"></script>
    <script src="scripts/workerService.js"></script>
    <script src="scripts/inputParser.js"></script>
    <script src="scripts/inputController.js"></script>
    <script src="scripts/gameController.js"></script>
    <!-- endbuild -->
</body>
</html>
